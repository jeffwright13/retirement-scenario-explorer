<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Retirement Scenario Explorer</title>
  <script src="https://cdn.plot.ly/plotly-3.1.0.js" charset="utf-8"></script>
  <!-- AJV temporarily disabled due to MIME type issues -->
  <!-- <script src="https://unpkg.com/ajv@8.12.0/dist/ajv.bundle.js"></script> -->

  <!-- CSS Architecture -->
  <link rel="stylesheet" href="styles/reset.css">
  <link rel="stylesheet" href="styles/variables.css">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/monte-carlo.css">
  <link rel="stylesheet" href="styles/monte-carlo-charts.css">
  <link rel="stylesheet" href="styles/monte-carlo.css">
  <link rel="stylesheet" href="styles/custom-scenario-modal.css">
  <link rel="stylesheet" href="styles/info-modal.css">
  <link rel="stylesheet" href="styles/utilities.css">
  <link rel="stylesheet" href="styles/workflow.css">
  <link rel="stylesheet" href="styles/scenario-builder.css">
</head>
<body>
  <div class="app-container">
    <!-- Mode Selector Header -->
    <div class="mode-selector-header">
      <h1>💰 Retirement Scenario Explorer 
        <button id="info-icon" class="info-icon" title="About this tool">ℹ️</button>
      </h1>
      <p>Will your assets and strategy stand the test of time?</p>
      
      <!-- Mode toggle removed - Story Mode is disabled -->
    </div>

    <!-- Story Mode Container -->
    <div class="story-mode-container" id="story-mode-container">
      <div class="story-panel" id="story-panel">
      <div class="story-header">
        <h3>📚 Storyteller Mode</h3>
        <button id="story-exit-btn" class="btn btn--exit-story">Exit Story</button>
      </div>

      <!-- Story Selection -->
      <div class="story-selector-section">
        <label for="story-selector" class="form-label"><strong>Choose Your Journey:</strong></label>
        <select id="story-selector" class="form-select story-dropdown">
          <option value="">Choose a Story...</option>
        </select>
      </div>

      <!-- Story Introduction Section -->
      <div class="story-introduction-section" id="story-introduction-section">
        <div class="introduction-header">
          <h4>📖 Story Introduction</h4>
          <button id="story-introduction-dismiss" class="btn btn--dismiss" title="Close introduction">✕</button>
        </div>
        <div class="introduction-content">
          <p id="story-introduction-text">Story introduction text will appear here...</p>
          <div class="introduction-actions">
            <!-- <button id="story-introduction-dismiss" class="btn btn--primary">Begin Story →</button> -->
          </div>
        </div>
      </div>

      <!-- Story Error Section -->
      <div class="story-error-section" id="story-error-section">
        <div class="error-header">
          <h4>⚠️ Content Issue</h4>
          <button id="story-error-dismiss" class="btn btn--dismiss" title="Dismiss error">✕</button>
        </div>
        <div class="error-content">
          <p id="story-error-text">Error details will appear here...</p>
        </div>
      </div>

      <!-- Story Progress -->
      <div class="story-progress-section" id="story-progress">
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" id="chapter-progress"></div>
          </div>
          <span class="progress-text" id="chapter-counter">Chapter 1 of 3</span>
        </div>
      </div>

      <!-- Story Content -->
      <div class="story-content" id="story-narrative">
        <div class="chapter-header">
          <h4 class="chapter-title" id="story-chapter-title">Chapter Title</h4>
        </div>

        <div class="story-section story-section--intro">
          <h5>🎯 What We're Exploring</h5>
          <p id="story-introduction">Chapter introduction text...</p>
        </div>

        <div class="story-section story-section--setup">
          <h5>⚙️ The Scenario</h5>
          <p id="story-setup">Scenario setup explanation...</p>
        </div>

        <div class="story-section story-section--takeaway" id="story-takeaway-section">
          <h5>💡 Key Takeaway</h5>
          <p id="story-key-takeaway" class="key-takeaway-text">Main lesson from this chapter...</p>
        </div>
      </div>

      <!-- Story Navigation -->
      <div class="story-navigation" id="story-navigation">
        <button id="story-prev-btn" class="btn btn--story-nav btn--prev" disabled>
          ← Previous
        </button>
        <button id="story-next-btn" class="btn btn--story-nav btn--next">
          Next Chapter →
        </button>
      </div>
    </div>

    <!-- Story Scenario Details -->
    <div class="story-scenario-details" id="story-scenario-details">
      <details class="scenario-details-collapsible">
        <summary>📋 Current Scenario Details</summary>
        <div class="scenario-details-content">
          <p id="story-scenario-description">Scenario description will appear here...</p>

          <div class="key-assumptions" id="story-key-assumptions">
            <h4>🔑 Key Assumptions</h4>
            <ul id="story-key-assumptions-list"></ul>
          </div>

          <details>
            <summary>👀 JSON Configuration</summary>
            <pre id="story-scenario-json-preview" class="code-preview"></pre>
          </details>
        </div>
      </details>
      </div>
    </div>

    <!-- Scenario Mode Container -->
    <div class="scenario-mode-container" id="scenario-mode-container">
      <!-- Guided Workflow Progress -->
      <div class="workflow-progress">
        <div class="workflow-steps">
          <div class="workflow-step active" data-step="1" id="workflow-step-1">
            <div class="step-indicator">
              <span class="step-number">1</span>
              <span class="step-icon">🎯</span>
            </div>
            <div class="step-content">
              <h3 class="step-title">Choose Your Scenario</h3>
              <p class="step-description">Select or create your retirement scenario</p>
            </div>
            <div class="step-status" id="step-1-status">
              <span class="status-indicator pending">⏸️</span>
            </div>
          </div>
          
          <div class="workflow-step locked" data-step="2" id="workflow-step-2">
            <div class="step-indicator">
              <span class="step-number">2</span>
              <span class="step-icon">📊</span>
            </div>
            <div class="step-content">
              <h3 class="step-title">Test Scenario</h3>
              <p class="step-description">Run single analysis to see results</p>
            </div>
            <div class="step-status" id="step-2-status">
              <span class="status-indicator locked">🔒</span>
            </div>
          </div>
          
          <div class="workflow-step locked" data-step="3" id="workflow-step-3">
            <div class="step-indicator">
              <span class="step-number">3</span>
              <span class="step-icon">🎲</span>
            </div>
            <div class="step-content">
              <h3 class="step-title">Risk Analysis</h3>
              <p class="step-description">Run Monte Carlo for statistical insights</p>
            </div>
            <div class="step-status" id="step-3-status">
              <span class="status-indicator locked">🔒</span>
            </div>
          </div>
        </div>
        
        <div class="workflow-progress-bar">
          <div class="progress-fill" id="workflow-progress-fill" style="width: 0%"></div>
        </div>
        
      </div>


      <!-- Custom Scenario Management Modal -->
      <div id="custom-scenario-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>🗂️ Manage Custom Scenarios</h3>
            <button class="modal-close" id="close-custom-modal">&times;</button>
          </div>
          <div class="modal-body">
            <div class="storage-info" id="storage-info">
              <p>Loading storage information...</p>
            </div>
            <div class="scenario-list" id="custom-scenario-list">
              <p>Loading custom scenarios...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button id="clear-all-custom" class="btn btn--danger">🗑️ Clear All Custom Scenarios</button>
            <button id="close-modal-btn" class="btn btn--secondary">Close</button>
          </div>
        </div>
      </div>

      <!-- Workflow Content -->
      <div class="workflow-content">
        <!-- Step 1: Choose Scenario -->
        <div class="workflow-panel active" id="step-1-panel" data-step="1">
          <div class="scenario-selector">
            <select id="scenario-dropdown" class="form-select scenario-dropdown btn btn--success btn--large">
              <option value="" style="font-weight: bold;">Choose Your Scenario</option>
            </select>
          </div>
          
          <div class="scenario-actions">
            <button type="button" class="btn btn-primary" id="create-scenario-btn">
              <span class="btn-icon">✨</span>
              Create New Scenario
            </button>
          </div>
          
          <div class="scenario-preview hidden" id="scenario-preview">
            <h4>📋 Scenario Details:</h4>
            <p id="scenario-description"></p>

            <!-- Enhanced Configuration Synopsis -->
            <div class="scenario-config-synopsis" id="scenario-config-synopsis">
              <div class="config-section">
                <h4>🔑 Key Assumptions</h4>
                <ul id="key-assumptions-list"></ul>
              </div>
              
              <div class="config-section">
                <h4>💰 Financial Overview</h4>
                <div class="config-grid">
                  <div class="config-item">
                    <span class="config-label">Starting Assets:</span>
                    <span class="config-value" id="config-total-assets">--</span>
                  </div>
                  <div class="config-item">
                    <span class="config-label">Monthly Expenses:</span>
                    <span class="config-value" id="config-monthly-expenses">--</span>
                  </div>
                  <div class="config-item">
                    <span class="config-label">Income Sources:</span>
                    <span class="config-value" id="config-income-count">--</span>
                  </div>
                  <div class="config-item">
                    <span class="config-label">Simulation Duration:</span>
                    <span class="config-value" id="config-duration">--</span>
                  </div>
                </div>
              </div>
              
              <div class="config-section">
                <h4>📊 Asset Breakdown</h4>
                <div id="config-assets-breakdown" class="assets-breakdown"></div>
              </div>
              
              <div class="config-section">
                <h4>💵 Income Streams</h4>
                <div id="config-income-breakdown" class="income-breakdown"></div>
              </div>
              
            </div>
            
            <!-- JSON Editor (initially hidden) -->
            <div class="json-editor-section" id="json-editor-section" style="display: none;">
              <div class="json-editor-header">
                <h4>📝 Edit Scenario Configuration</h4>
                <p>Modify the scenario data directly. Changes will be validated before saving.</p>
              </div>
              <div class="json-editor-container">
                <textarea id="json-editor" class="json-editor" rows="20" placeholder="Scenario JSON will appear here..."></textarea>
              </div>
              <div class="json-editor-actions">
                <button id="save-json-btn" class="btn btn--success">💾 Save as Custom Scenario</button>
                <button id="cancel-json-btn" class="btn btn--secondary">❌ Cancel</button>
                <button id="validate-json-btn" class="btn btn--secondary">✅ Validate JSON</button>
                <button id="highlight-all-json-btn" class="btn btn--secondary">🔍 Highlight All</button>
                <button id="export-config-btn" class="btn btn--secondary">📄 Export Config</button>
              </div>
              <div id="json-validation-feedback" class="validation-feedback"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Test Scenario -->
        <div class="workflow-panel" id="step-2-panel" data-step="2">
          
          <div class="analysis-status" id="single-analysis-status">
            <p>Complete Step 1 to unlock this analysis.</p>
          </div>
          
          <!-- Single Scenario Simulation Controls -->
          <div class="simulation-controls">
            <button id="run-btn-primary" class="btn btn--success btn--large" disabled>
              🚀 Run Single Scenario
            </button>
          </div>
          
          <div class="simulation-feedback" id="simulation-feedback">
            <div class="feedback-item" id="simulation-status-feedback" style="display: none;">
              <span class="feedback-icon">⏳</span>
              <span class="feedback-text">Running simulation...</span>
            </div>
            <div class="feedback-item" id="simulation-success-feedback" style="display: none;">
              <span class="feedback-icon">✅</span>
              <span class="feedback-text">Simulation complete!</span>
            </div>
          </div>
          
          <!-- Single Scenario Results -->
          <div class="results-section" id="single-scenario-section">
            <h4>📊 Single Scenario Results</h4>
            <div id="chart-area" class="chart-area"></div>
          </div>

          <!-- Key Insights -->
          <div class="results-section" id="insights-section">
            <h4>💡 Key Insights</h4>
            <ul id="insights-list"></ul>
          </div>
          
          <div class="simulation-options">
            <button id="toggle-csv-btn" class="btn btn--secondary" style="display: none;">📊 Export CSV Data</button>
          </div>
          
        </div>

        <!-- Step 3: Risk Analysis -->
        <div class="workflow-panel" id="step-3-panel" data-step="3">
          
          <div class="analysis-status" id="monte-carlo-analysis-status">
            <p>Complete Steps 1 & 2 to unlock Monte Carlo analysis.</p>
          </div>
          
          <!-- Monte Carlo Simulation Controls -->
          <div class="simulation-controls">
            <button id="run-monte-carlo-btn" class="btn btn--success btn--large" disabled>
              🎲 Select Scenario First
            </button>
            
            <!-- Configuration Toggle -->
            <div class="config-toggle-container">
              <label class="config-toggle-label">
                <input type="checkbox" id="show-monte-carlo-config" class="config-toggle-checkbox" checked>
                <span class="config-toggle-text">⚙️ Show Configuration Options</span>
              </label>
            </div>
          </div>

          <!-- Monte Carlo Configuration (Collapsible) -->
          <div class="monte-carlo-section monte-carlo-config-expanded" id="monte-carlo-section">
            <div class="monte-carlo-header">
              <h4>🎲 Monte Carlo Configuration</h4>
              <div class="monte-carlo-actions">
                <button id="cancel-monte-carlo" class="btn btn--secondary" style="display: none;">
                  ❌ Cancel Analysis
                </button>
              </div>
            </div>
            
            <div class="monte-carlo-config">
              <div class="config-grid">
                <div class="config-item">
                  <label for="monte-carlo-iterations" class="config-label">Iterations</label>
                  <input type="number" id="monte-carlo-iterations" class="config-input" value="100" min="100" max="10000" step="100">
                  <span class="config-hint">Accuracy vs speed</span>
                </div>
                
                <div class="config-item">
                  <label for="monte-carlo-target-years" class="config-label">Target Years</label>
                  <input type="number" id="monte-carlo-target-years" class="config-input" value="25" min="1" max="50" step="0.5">
                  <span class="config-hint">Money duration goal</span>
                </div>
                
                <div class="config-item">
                  <label for="monte-carlo-success-rate" class="config-label">Success Rate</label>
                  <div class="input-with-unit">
                    <input type="number" id="monte-carlo-success-rate" class="config-input" value="80" min="50" max="99" step="5">
                    <span class="input-unit">%</span>
                  </div>
                  <span class="config-hint">Confidence level</span>
                </div>
                
                
                <div class="config-item">
                  <label for="monte-carlo-return-model" class="config-label">Return Model</label>
                  <select id="monte-carlo-return-model" class="config-input">
                    <option value="simple-random">Simple Random</option>
                    <option value="historical-bootstrap">Historical Bootstrap</option>
                    <option value="historical-sequence">Historical Sequence</option>
                  </select>
                  <span class="config-hint">Market return modeling approach</span>
                </div>
                
                <div class="config-item config-advanced">
                  <label for="monte-carlo-seed" class="config-label">Seed</label>
                  <input type="number" id="monte-carlo-seed" class="config-input" placeholder="Random">
                  <span class="config-hint">Reproducible results</span>
                </div>
              </div>
            </div>
            
            <div class="monte-carlo-progress" id="monte-carlo-progress" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill" id="monte-carlo-progress-fill"></div>
              </div>
              <div class="progress-text" id="monte-carlo-progress-text">Preparing analysis...</div>
            </div>
          </div>
          
          <div class="simulation-feedback" id="monte-carlo-feedback">
            <div class="feedback-item" id="monte-carlo-status-feedback" style="display: none;">
              <span class="feedback-icon">🎲</span>
              <span class="feedback-text">Monte Carlo analysis running...</span>
            </div>
            <div class="feedback-item" id="monte-carlo-success-feedback" style="display: none;">
              <span class="feedback-icon">📊</span>
              <span class="feedback-text">Monte Carlo analysis complete!</span>
            </div>
          </div>

          <!-- Monte Carlo Results -->
          <div class="results-section" id="monte-carlo-section-results" style="display: none;">
            <div class="monte-carlo-header">
              <h4>🎲 Monte Carlo Analysis Results</h4>
              <div class="monte-carlo-actions">
                <!-- Export functionality moved to centralized toolbar -->
              </div>
            </div>
            <div id="monte-carlo-chart-area" class="chart-area monte-carlo-chart-container">
              <!-- Monte Carlo trajectory chart will be rendered here -->
            </div>
            
            <!-- Compact Monte Carlo Analysis Summary -->
            <div class="results-section" id="monte-carlo-analysis-summary">
              <h5>📈 Analysis Summary</h5>
              <div id="monte-carlo-summary" class="monte-carlo-results-compact"></div>
              <div id="monte-carlo-insights" class="monte-carlo-insights-compact"></div>
            </div>

            <!-- Key Scenario Insights (separate from Monte Carlo analysis) -->
            <div class="results-section" id="monte-carlo-scenario-insights">
              <h5>💡 Key Scenario Insights</h5>
              <ul id="monte-carlo-insights-list"></ul>
            </div>
            
          </div>

          <!-- Coming Up Next -->
          <div class="next-scenario-suggestion" id="next-scenario-suggestion">
            <h4>📈 Coming Up Next...</h4>
            <p id="next-scenario-description"></p>
            <button class="btn btn--next-scenario" id="load-next-scenario">
              <!-- Text set dynamically -->
            </button>
          </div>
          
        </div>

        <!-- Compare tab removed - no implementation yet -->
      </div>

      <!-- Centralized Export Toolbar -->
      <div class="export-toolbar" id="export-toolbar">
        <div class="export-toolbar-content">
          <span class="export-toolbar-label">🔧 Scenario Tools:</span>
          <div class="export-buttons">
            <button id="toggle-json-btn" class="btn btn--export btn--small" title="Edit scenario data directly">
              📝 Edit Scenario Config
            </button>
            <button id="export-scenario-config" class="btn btn--export btn--small" title="Export current scenario configuration">
              📄 Export Scenario Config
            </button>
            <button id="export-scenario-results" class="btn btn--export btn--small" style="display: none;" title="Export single scenario results">
              📊 Results
            </button>
            <button id="export-monte-carlo-results" class="btn btn--export btn--small" style="display: none;" title="Export Monte Carlo analysis">
              🎲 MC Analysis
            </button>
            <button id="export-monte-carlo-returns" class="btn btn--export btn--small" style="display: none;" title="Export Monte Carlo return sequences">
              📈 MC Returns
            </button>
            <button id="manage-custom-scenarios" class="btn btn--export btn--small" title="Manage custom scenarios">
              🗂️ Manage Custom Scenarios
            </button>
          </div>
        </div>
      </div>

      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="info-modal" class="modal" style="display: none;">
    <div class="modal-content info-modal-content">
      <div class="modal-header">
        <h2>🎯 Welcome to the Retirement Scenario Explorer</h2>
        <span class="modal-close" id="info-modal-close">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="info-section">
          <h3>💡 What is this tool?</h3>
          <p>The Retirement Scenario Explorer is a financial planning tool that helps you test whether your retirement strategy can withstand various market conditions and life circumstances, giving you the data you need to asure yourself that your money won't run out before you expect it to.</p>
        </div>

        <div class="info-section">
          <h3>🎯 Why was it created?</h3>
          <p>When I wanted to see if my assets were going to last me as long as I needed them to, I searched online for a tool that would just tell me the answer. Unfortunately, none of them really suited my specific needs; it was clear that if I wanted personalized answers, I needed to build my own tool.</p>
          <p>This tool lets you:</p>
          <ul>
            <li><strong>Test realistic scenarios</strong> - Market crashes, inflation spikes, unexpected expenses, inheritances, Social Security income scenarios (including SSDI), Medicare premiums, home maintenance costs, etc. Pretty much anything you can think of!</li>
            <li><strong>See the full picture</strong> - How your assets, income, and expenses interact over time</li>
            <li><strong>Understand risk</strong> - What could go wrong and how likely it is (Monte Carlo analysis)</li>
            <li><strong>Make informed decisions</strong> - Adjust your strategy based on data, not guesswork</li>
          </ul>
        </div>

        <div class="info-section">
          <h3>🚀 Simple 3-Step Process</h3>
          
          <div class="walkthrough-step">
            <h4>🎯 Step 1: Choose or Create Your Scenario</h4>
            <p>Select from pre-built scenarios or create your own. The tool will guide you through each step and unlock the next one automatically.</p>
          </div>

          <div class="walkthrough-step">
            <h4>📊 Step 2: Test Your Scenario</h4>
            <p>See exactly how your money flows month by month. You'll get insights about when assets run out and how income covers expenses.</p>
          </div>

          <div class="walkthrough-step">
            <h4>🎲 Step 3: Understand Your Risk</h4>
            <p>Test against thousands of market conditions to see your probability of success and identify potential risks.</p>
          </div>
        </div>

        <div class="info-section">
          <h3>💪 Ready to get started?</h3>
          <p>The tool will guide you step-by-step. Just follow the workflow indicators at the top!</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button id="info-modal-got-it" class="btn btn--primary">Got it, let's explore! 🚀</button>
      </div>
    </div>
  </div>

  <script type="module" src="scripts/main.js"></script>
</body>
</html>
